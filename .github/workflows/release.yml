name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    name: Build ISO and Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v30
        with:
          github_access_token: ${{ secrets.GITHUB_TOKEN }}
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Setup Cachix
        uses: cachix/cachix-action@v12
        with:
          name: tuinix
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
        continue-on-error: true

      - name: Build installer ISO
        run: |
          nix build .#nixosConfigurations.installer.config.system.build.isoImage --show-trace

      - name: Determine tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG=${{ github.event.inputs.tag }}
          else
            TAG=${GITHUB_REF#refs/tags/}
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" "$LAST_TAG"..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)")
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update docs ISO references
        run: |
          TAG=${{ steps.tag.outputs.tag }}
          ISO_FILE=$(basename result/iso/*.iso)
          DOWNLOAD_URL="https://github.com/timlinux/tuinix/releases/download/${TAG}/${ISO_FILE}"
          RELEASES_URL="https://github.com/timlinux/tuinix/releases/latest"

          # Update mkdocs.yml extra.iso values
          sed -i "s|version: \".*\"|version: \"${TAG}\"|" mkdocs.yml
          sed -i "s|filename: \".*\"|filename: \"${ISO_FILE}\"|" mkdocs.yml
          sed -i "s|download_url: \".*\"|download_url: \"${DOWNLOAD_URL}\"|" mkdocs.yml

          # Commit and push the updated docs config
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add mkdocs.yml
          git diff --cached --quiet || git commit -m "docs: update ISO references to ${TAG}"
          git push origin HEAD:main

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## Changes
            ${{ steps.changelog.outputs.changelog }}

            ## Installation
            Download the ISO image below and follow the [installation guide](https://timlinux.github.io/tuinix/installation/).

            Flash to USB:
            ```bash
            sudo dd if=tuinix-installer.iso of=/dev/sdX bs=4M status=progress oflag=sync
            ```
          files: |
            result/iso/*.iso
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
